<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Usuários</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="header-container">
      <img src="img/logo.jpg" alt="Logo" class="logo">
      <h1>Consulta de Usuários</h1>
      <div class="user-info">
        <span id="userName"></span>
        <button id="logoutBtn" class="sair-btn">Sair</button>
      </div>
    </div>
  </header>

  <main>
    <div id="adminFiltro" style="margin-bottom: 15px;">
      <label for="buscaNome">Buscar por nome:</label>
      <input type="text" id="buscaNome" placeholder="Digite um nome">
    </div>

    <table id="usuariosTable">
      <thead>
  <tr>
    <th>ID</th>
    <th>Nome</th>
    <th>Email</th>
    <th>Data Nascimento</th>
    <th>CEP</th>
    <th>Logradouro</th>
    <th>Bairro</th>
    <th>Cidade</th>
    <th>Estado</th>
    <th>Cunhado</th>
    <th>Foto</th>
    <th>Ações</th>
  </tr>
</thead>

      <tbody>
        <tr><td colspan="9" style="text-align:center;">Carregando...</td></tr>
      </tbody>
    </table>

    <div id="paginacaoContainer" class="paginacao">
      <button id="prevPage">Anterior</button>
      <span id="pageInfo"></span>
      <button id="nextPage">Próxima</button>
    </div>
  </main>

  <footer>
    <p>© 2025 - Sistema de Usuários</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const user = JSON.parse(localStorage.getItem("user"));
      const userNameEl = document.getElementById("userName");
      const logoutBtn = document.getElementById("logoutBtn");
      const buscaInput = document.getElementById("buscaNome");
      const adminFiltro = document.getElementById("adminFiltro");
      const tabelaBody = document.querySelector("#usuariosTable tbody");
      const paginacaoContainer = document.getElementById("paginacaoContainer");
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");
      const pageInfo = document.getElementById("pageInfo");

      let usuarios = [];
      let paginaAtual = 1;
      const itensPorPagina = 5;

      // Se não estiver logado
      if (!user || !user.token) {
        window.location.href = "index.html";
        return;
      }

      // Exibe nome do usuário
      userNameEl.textContent = `${user.nome_completo || user.email} (${user.perfil})`;

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("user");
        window.location.href = "index.html";
      });

      if (user.perfil !== "admin") {
        adminFiltro.style.display = "none";
        paginacaoContainer.style.display = "none";
      }

      buscaInput.addEventListener("input", () => {
        renderTabela(filtrarUsuarios());
      });

      prevPageBtn.addEventListener("click", () => {
        if (paginaAtual > 1) {
          paginaAtual--;
          renderTabela(filtrarUsuarios());
        }
      });

      nextPageBtn.addEventListener("click", () => {
        const totalPaginas = Math.ceil(filtrarUsuarios().length / itensPorPagina);
        if (paginaAtual < totalPaginas) {
          paginaAtual++;
          renderTabela(filtrarUsuarios());
        }
      });

      async function carregarUsuarios() {
        try {
          const resp = await fetch("/users", {
            headers: { Authorization: "Bearer " + user.token },
          });

          if (!resp.ok) throw new Error("Erro ao buscar usuários.");
          usuarios = await resp.json();
          renderTabela(usuarios);
        } catch (error) {
          console.error(error);
          alert("Erro ao carregar usuários.");
        }
      }

      function filtrarUsuarios() {
        const termo = buscaInput.value.toLowerCase();
        return usuarios.filter((u) => u.nome_completo?.toLowerCase().includes(termo));
      }

      function formatarData(dataISO) {
        if (!dataISO) return "";
        const d = new Date(dataISO);
        if (isNaN(d)) return "";
        return d.toLocaleDateString("pt-BR", { timeZone: "UTC" });
      }

      function renderTabela(lista) {
        tabelaBody.innerHTML = "";
        let pagina = lista;

        if (user.perfil === "admin") {
          const inicio = (paginaAtual - 1) * itensPorPagina;
          const fim = inicio + itensPorPagina;
          pagina = lista.slice(inicio, fim);
        }

        if (pagina.length === 0) {
          tabelaBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Nenhum usuário encontrado</td></tr>`;
          pageInfo.textContent = `Página 0 de 0`;
          return;
        }

        for (const u of pagina) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${u.id}</td>
            <td>${u.nome_completo || ""}</td>
            <td>${u.email}</td>
            <td>${formatarData(u.data_nascimento)}</td>
            <td>${u.endereco?.cep || ""}</td>
            <td>${u.endereco?.logradouro || ""}</td>
            <td>${u.endereco?.bairro || ""}</td>
            <td>${u.endereco?.cidade || ""}</td>
            <td>${u.endereco?.estado || ""}</td>
            <td>${u.cunhado || ""}</td>
            <td>
              ${
                u.foto_url
                  ? `<img src="${u.foto_url}" alt="foto" class="foto-thumb">`
                  : "—"
              }
            </td>
            <td><button class="editarBtn" data-id="${u.id}">Editar</button></td>
          `;
          tabelaBody.appendChild(tr);
        }

        if (user.perfil === "admin") {
          const totalPaginas = Math.ceil(lista.length / itensPorPagina);
          pageInfo.textContent = `Página ${paginaAtual} de ${totalPaginas}`;
        } else {
          pageInfo.textContent = "";
        }

        document.querySelectorAll(".editarBtn").forEach((btn) => {
          btn.addEventListener("click", () => {
            window.location.href = `edicao.html?id=${btn.dataset.id}`;
          });
        });

        document.querySelectorAll(".foto-thumb").forEach((img) => {
          img.addEventListener("click", () => {
            const modal = document.createElement("div");
            modal.className = "modal-foto";
            const imgModal = document.createElement("img");
            imgModal.src = img.src;
            modal.appendChild(imgModal);
            modal.addEventListener("click", () => modal.remove());
            document.body.appendChild(modal);
          });
        });
      }

      carregarUsuarios();
    });
  </script>
</body>
</html>
